const _ = require('lodash'),
  {getCamelCaseImpl} = require('@wix/wnp-rpc-common'),
  {util} = require('@wix/wix-proto-runtime-toolkit');

const options = util.options('wix.api');
const fieldCamelCase = getCamelCaseImpl(true).fieldCamelCase;

function isValidPrimitiveType(value, type) {

  switch (type) {
    case 'bool':
      return typeof value === 'boolean';
    case 'string':
      return typeof value === 'string';
    case 'int32':
    case 'fixed32':
    case 'uint32':
    case 'sint32':
      return Number(value) === value && value % 1 === 0;
    case 'float':
    case 'double':
      return Number(value) === value;
    case 'int64':
    case 'fixed64':
    case 'uint64':
    case 'sint64':
      return typeof value === 'string' && /^-?\d+$/.test(value);
    default:
      return true;
  }
}

function isValidEnumType(value, enumType) {
  const enumValues = _.get(enumType, 'values');
  const looksLikeEnum = _.isObject(enumValues) && !_.isArray(enumValues);
  return looksLikeEnum && enumValues.hasOwnProperty(value);
}

function getWixOptionsWithTypes(node) {
  return options(node).find(/.*/, true).map(([name, value]) => {
    let path = [];
    name = fieldCamelCase(name);
    if (name.indexOf('.') >= 0) {
      ([name, ...path] = name.split('.'));
    }
    return {name, value, path};
  });
}

module.exports = {isValidPrimitiveType, isValidEnumType, getWixOptionsWithTypes};
