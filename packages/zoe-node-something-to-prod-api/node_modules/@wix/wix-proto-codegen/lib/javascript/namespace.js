const e = require('estree-builder'),
  protobuf = require('@wix/wnp-protobufjs'),
  types = require('./types'),
  services = require('./services'),
  {EMPTY_OBJ} = require('./util');


const DEFAULT_HANDLERS = {
  'Type': types.create,
  'Enum': types.create,
  'Field': types.create,
  'Service': services.create
};

function create(hostIdentifier, container, opts, handlers = DEFAULT_HANDLERS) {

  return container.nestedArray.reduce((acc, obj) => {
    const maybeCreated = generateEntry(obj, handlers, opts);

    if (maybeCreated) {
      acc.push(e(';', e('=', e('.', hostIdentifier, e.id(obj.name)), maybeCreated)));
    }
    return acc;

  }, []);
}

function generateEntry(obj, handlers, opts) {
  if (obj.constructor.name === protobuf.Namespace.name) {
    const safeName = `_${obj.name}`;
    return e.statement(e.call(e.fn([], [
      e.const(safeName, EMPTY_OBJ),
      ...create(e.id(safeName), obj, opts),
      e.return(e.id(safeName))
    ]), []));
  } else {
    return handlers[obj.constructor.name](obj, opts);
  }
}

module.exports = {create};
