# wix-proto-codegen

CLI & programmatic utility for consuming RPC proto definition modules and code generation.

**Note: requires node version >= 12**

Scans your production dependencies (in package.json) and generates JavaScript and TypeScript classes for it.

Programmatic api also returns a list of all pre-loaded proto modules file names(e.g. ['google/api/http.proto','wix/api/context.proto',...]).

**Note**: the generated TypeScript declarations (unless opted out) include an additional dependencies you might have to add to your
`package.json`:

- [`long`](https://www.npmjs.com/package/long)
- [`@wix/wix-aspects`](https://github.com/wix-platform/wix-node-platform/tree/master/aspects/wix-aspects)

## TOC
- [Installation](#install)
- [Usage](#usage)
    - [Programmatic](#programmatic)
    - [CLI script](#via-packagejson-build-step)
- [API Module](#api-module)
    - [How to locate required API module](#finding-the-right-npm-modules-to-add-when-trying-to-consume-a-proto-api)
    - [Consuming API defined in scala](#consuming-a-proto-based-scala-service)
    - [Consuming API defined in node](#consuming-a-proto-based-node-service)
- [API](#api)
- [CLI API](#cli-api)
- [google.protobuf.Any support](#googleprotobufany-support)


## install

```
npm install --save-dev @wix/wix-proto-codegen
```

## Usage

### programmatic
```js
const wixProtoCodegen = require('@wix/wix-proto-codegen');

const opts = {
  target: {
    name: 'proto-generated',
    dir: './src/generated'      // for ts projects it is recommended to generate into src and not dist
  },
  moduleDir: '/path/to/module'  // path to your module root dir
};

await wixProtoCodegen(opts);
/* /path/to/module/src/generated will contain all generated files as listed below */

/* in case you need the list of bundled proto files you may use */
const filesNames = await wixProtoCodegen.tools.listBundledProtoFiles();
```

### via package.json build step
_package.json_
```json
{
    "scripts": {
        "build": "wix-proto-codegen --module ."
    },
    "dependencies": {
        "@wix/meta-site-api-proto": "^1.0.0"
    },
    "devDependencies": {
        "@wix/wix-proto-codegen": "^1.0.0"
    }
}
```

## API module

In order for a module to be consumed by `wix-proto-codegen`, module has to satisfy following requirements:
 - `package.json` must contain flag `wnp_type` set to `proto`;
 - `*.proto` files must be placed in `./src/main/proto`;

 In addition google.api google.protobuf and wix.api proto files are bundled with wix-proto-codegen and must not be in your proto path,
 to get the full list of pre loaded protos files please use listBundledProtoFiles api.

Both modules provided by jvm and npm platforms are consumable.

### Finding the right npm modules to add when trying to consume a .proto API
Interoperability between Node and JVM with regards to APIs is supported by having automatically generated shadow builds for the other platform - [more details](https://github.com/wix-private/wix-ci/blob/master/proto-sync/README.md).

#### Consuming a proto based Scala Service
As an example, suppose you want to consume the [CampaignService](https://github.com/wix-private/promote-server/blob/4f5e2a37fe0f615646f221f08a5019e1495c027f/shoutout-server/shoutout-platform/shoutout-platform-api/src/main/proto/wix/emailmarketing/api/v1/campaign-service.proto) API
- Find the `BUILD.bazel` file above it [Here](https://github.com/wix-private/promote-server/tree/4f5e2a37fe0f615646f221f08a5019e1495c027f/shoutout-server/shoutout-platform/shoutout-platform-api/src/main/proto) which contains the following:
```
wix_proto_library(
    name = "proto",
    srcs = glob(["**/*.proto"]),
    artifact_id = "shoutout-platform-api",
    group_id = "com.wixpress.shoutout",
    visibility = ["//visibility:public"],
    deps = [
        "@com_wixpress_p13n_protos_common_proto//:proto",
        "@com_wixpress_proto_later_api_proto//:proto",
    ],
)
```
- Find the `artifact_id` part and add it as a dev dependency like this: `"@wix/{artifact_id}"`. In our example this will be `"@wix/shoutout-platform-api"`
- In case this module depends on external protos, they will appear in the `deps` section. In our example we have two such dependencies.
- The dependencies are in the format `"@${group_id}_${artifact_id}_proto//:proto"` so you'll have to guess which part is the `group_id` and which is the `artifact_id` and replace `_` with `-`
- In the example above, you'll need to add the following dependencies: `@wix/protos-common` and `@wix/later-api`
- You can validate these modules exists using `npm info <module>`
- Note that if one of those modules (i.e. `later-api`) also depends on other proto files, you'll have to find and add those dependencies too

*Note: If you received the error `code generation failed:  cannot resolve import wix/common/paging.proto` (or a similar one) while 
running `wix-proto-codegen` then you are missing a dependency and need to follow the above procedure carefully. At least until [this](https://jira.wixpress.com/browse/HAL-443) is fixed*


#### Consuming a proto based Node Service
As an example, suppose you want to consume the [PixServer](https://github.com/wix-private/pix/blob/cf51bef17e877345ac0cbccfc0f03b0ed9d68c38/api/src/main/proto/pix-service.proto) API
- Find the `package.json` above it which contains the following
```
  ...
  "name": "@wix/media-pix-api"
  "wnp_type": "proto",
  ...
```
- Add the package name to your dependencies list. In our example it's `@wix/media-pix-api`

## API

### wixProtoCodegen(opts): Promise\<Root | null\>
Runs the code generation

- `opts.target.name` - the name of the generated js files
- `opts.target.dir`- the name of the folder the generated js/ts files will be generated in
- `opts.moduleDir` - the name of the folder your npm module with `package.json` file is located
- `opts.skipGeneration` - do not run code generation, only resolve protobuf files
- `opts.strictMode` - run code generation in strict mode which performs more strict validations to proto files.
   This might cause issues when generating code from multiple independent APIs. Currently used only in [wix-proto-module-validator](../wix-proto-module-validator)
- `opts.withAspectlessServices` - in generated client service interface, generate methods overload for that allows calling them without `aspects`. enabled by default
- `opts.alternateCommentMode` - parse proto comments api descriptions which don't adhere to the docblock style.
- `opts.preferTrailingComment` - prefer trailing comments when parse proto comments api descriptions.
- `opts.stdCase` - **(EXPERIMENTAL, DO NOT USE)** causes field names and method names to use standard camel casing which is interoperable with Scala services 

Upon success resolves with instance of `protobufjs.Root` **only** if `opts.skipGeneration` is `false`, otherwise
resolves with `null`

### wixProtoCodegen.generateFromJson(json: object): Promise\<string\>

**This is an internal API for the [ambassador](https://github.com/wix-private/ambassador) that should not be used directly from user code.**

Runs the codegen for a given protobuf JSON (in [protobufjs](https://github.com/protobufjs/protobuf.js#using-json-descriptors) format).
Resolves with a string that represents the generated JavaScript (no TypeScript declarations).

### tools: object
Return set of tools to be used in special low-level cases. Have no usage for regular proto modules.

#### tools#listBundledProtoFiles(): string[]
Returns the bundled proto files names list (e.g. ['google/api/http.proto','wix/api/context.proto',...]).

#### tools#listBundledRoots(): string[]
Returns the list of root folders of bundled proto files.

#### tools#Module: class
Returns the `Module` class that used to load Wix-structured proto modules and its dependencies.

#### tools#protoAstTraverser(node: protobufjs.ReflectionObject): { visit(handlers): void }
Returns a traverser that starts from `node`. Call `#visit` with `handlers` in order to traverse the AST.

Handler names are `beforeX` and `afterX` (where `X` is the node type). It will be called for each node before/after further nodes lookup.

```js
const { tools } = require('@wix/wix-proto-codegen');

tools.protoAstTraverser(rootNode).visit({
  afterMethod(methodNode) {
    // called for each method, after all methodNode found
  },

  beforeType(typeNode) {
    // called for each type, right after that type was found
  },
})
```

## Creating/publishing API modules

Same rules apply as for `Consuming API module`, but also:
 - module must not contain `pom.xml`.

This is because CI creates shadow builds for jvm platform and it injects special `pom.xml` for npm-first module would be consumable.

For an example see [test module](./test/modules/provider).

## CLI API
`npx @wix/wix-proto-codegen [options]`

Arguments:

parameter|mandatory|description
---|---|---
`--module` | yes | relative/absolute path to npm module (or module id for wix-scoped modules) for which the generation should happen;
`--filename` | no | target file name. defaults to `proto-generated`;
`--dir` | no | target directory for generated code. relative to `--module` or absolute, defaults to `./dist`.
`--stringEnums` | no | use strings for enum literals
`--stringLongs` | no | use strings for int 64 types
`--tsClasses` | no | generate both interface and class for messages in the TypeScript declarations file, defaults to `false` (meaning generate interface only).
`--tsExportDefault` | no | causes the generated TypeScript declaration file to have `export default` instead of `export =`.
`--skipOptionsValidation` | no | skip validation of option types, defaults to `false`. Provide the name of a specific module to skip (e.g. `--skipOptionsValidation @wix/someWixModule anotherModule`) or leave blank to skip all modules.(More [info about options](https://bo.wix.com/wix-docs/rnd/platformization-guidelines/protobuf#platformization-guidelines_protobuf_options)).
`--withAspectStore` | no | generates service methods parameter `aspects: AspectStore` (from `@wix/wix-aspects`) instead of `aspects: object`. Defaults to `true`.
`--skipClientServer` | no | disables generation of client\\server specific `.d.ts` files
`--generateVerify` | no | forces generation of `MessageClass.verify(...)`. **@deprecated** - use [wix-proto-validation](../wix-proto-validation) instead.
`--withAspectlessServices` | no | in generated client service interface, generate methods overload that allows calling them without `aspects`. enabled by default
`--stdCase` |no | **EXPERIMENTAL, DO NOT USE** causes field names and method names to use standard camel casing which is interoperable with Scala services. defaults to `false`
`--legacy` | no | disables all the recently added features: `--withAspectStore`, `--skipClientServer`, `, --withAspectlessServices`

## Typescript Declarations

`wix-proto-codegen` generates both JavaScript files and appropriate TypeScript declarations in the target directory.
For example, if you use `--dir ./src/generated` and `--filename stores` the following files will be generated:
- ./src/generated/stores.js
- ./src/generated/stores.d.ts

In addition, `wix-proto-codegen` will now generate client\\server specific files in the following structure:
- ./src/generated/client/stores.js
- ./src/generated/client/stores.d.ts
- ./src/generated/server/stores.js
- ./src/generated/server/stores.d.ts

The client\\server files are generated a bit different from the default declaration file, and they are more suitable for their
specific use cases. For example, in client declarations, responses returned from the server always contain values for primitives
(string, int, enum etc.) and they are not marked as "nullable" (i.e. `name: string` instead of `name?: string`). The same is true
for requests in server declarations. The declarations in the client\\server specific files are separated to different namespaces
according to their usage: `requests`,`responses`,`services`. 

**EXPERIMENTAL -** The client declarations for services also contain an overload for each method that does not have aspects as the 
first parameter, this API is available when running in an environment that supports 
`async-hooks#AsyncLocalStorage` (i.e. `node >= 12.17.x`).
When calling an RPC method without aspects, the aspects from the current request context are used.

**Known issue -** `sinon.createStubInstance(SomeService)` return type is missing the overloaded methods and therefore is incompatible with `typeof SomeService` and TS will throw when trying to assign the stub into the original type.
If you encounter this error you can disable the aspectless service interface generation by setting `--withAspectlessServices=false`.

Server declarations always contain the aspects as the first parameter, and can assume it is always provided to the implementation.

The following shows an example of how to migrate a server implementation
of a protobuf service from the default typescript declaration to the new "server specific" declaration:

```typescript
import {com} from './generated/proto-generated';

export class AnotherService extends com.wix.AnotherService {
  async foo(aspects: AspectStore, req: com.wix.GreetingRequest): Promise<com.wix.GreetingResponse> {
    const greeter: string = req.name!; //<-- note here the usage of the ! operator
    ...
  }
}
```

```typescript
import {services, requests, responses} from './generated/server/proto-generated';

export class AnotherService extends services.com.wix.AnotherService {
  async foo(aspects: AspectStore, req: requests.com.wix.GreetingRequest): Promise<responses.com.wix.GreetingResponse> {
    const greeter: string = req.name; //<-- ! operator no longer needed
    return {
      greeting: 'Hello ' + greeter
    };
  }
}
```

A similar change can be applied to client code in order to migrate it to use the new "client specific" declarations:

```typescript
import {com} from './generated/proto-generated';

async function callService(aspects: AspectStore) {
  const client: com.wix.AnotherService = createClient();

  const response = await client.foo(aspects, {name: 'shmug'});
  const greeting: string = response.greeting!; // <-- ! operator needed here
}
```

```typescript
import {services, requests, responses} from './generated/client/proto-generated';

async function callService(aspects: AspectStore) {
  const client: services.com.wix.AnotherService = createClient();

  const response = await client.foo(aspects, {name: 'shmug'});
  const greeting: string = response.greeting; // <-- ! operator no longer needed
}

// or, without aspects
async function callServiceWithoutAspects() {
  const client: services.com.wix.AnotherService = createClient();

  const response = await client.foo({name: 'shmug'});
  const greeting: string = response.greeting; // <-- ! operator no longer needed
}
```

## [google.protobuf.Any](https://developers.google.com/protocol-buffers/docs/proto3#any) Support
`google.protobuf.Any` support is new and experimental. Supported in gRPC, JSON-RPC and [REST*](#rest-support) transports.

In TypeScript using the `google.protobuf.Any` requires code generation with classes via the [`-tsClasses` option](#cli-api).

### Example

_proto/meta-site-api.proto_

```proto
syntax = "proto3";

import "google/protobuf/any.proto";
import "wix/api/validations.proto";

package com.wix.metasite;

message MetaSite {
    string id = 1 [(wix.api.format) = GUID];
    string name = 2 [(wix.api.maxLength) = 50];
    google.protobuf.Any site = 3;
};

message HtmlSite {
    string id = 1 [(wix.api.format) = GUID];
}

message FlashSite {
    int64 id = 1;
}
```

_src/using-any.ts_
```typescript
import {com, google} from './generated/meta-site-api';
import Long from 'long';
import * as uuid from 'uuid/v4';

// query & unpack
const metaSite: com.wix.metasite.IMetaSite = await getMetaSiteFromSomewhere();

if (metaSite.site!.is(com.wixpress.metasite.FlashSite)) {
    const flashSite: com.wix.metasite.IFlashSite = metaSite.site!.unpack(com.wix.metasite.FlashSite);
} else if (metaSite.site!.is(com.wixpress.metasite.HtmlSite)) {
    const htmlSite: com.wix.metasite.IHtmlSite = metaSite.site!.unpack(com.wix.metasite.HtmlSite);
} else {
    // unknown type of site, nothing I can do with it
}


// packing
const flashSite: google.protobuf.Any = google.protobuf.Any.pack(com.wix.metasite.FlashSite, {id: Long.fromInt(666)});
const metaSite: com.wix.metasite.IMetaSite = {
    id: uuid(),
    name: 'my-site',
    site: flashSite,
};
```

### google.protobuf.Any API

#### google.protobuf.Any#is(ctor: \<generated-type\>): boolean
Checks if current instance of `Any` contains `ctor`type.

#### google.protobuf.Any#unpack<T>(ctor: \<generated-type-T\>): T
Unpacks the contained type `T` to instance of `T` given it's constructor.

Throws `TypeError` in case the contained type does not match the requested type.

#### google.protobuf.Any#typeUrl: string
Returns the contained type URL in a form `type.googleapis.com/full.type.name` (eg. `type.googleapis.com/com.wix.metasite.FlashSite`)

#### google.protobuf.Any#typeName: string
Returns the contained type fully qualified type name without the namespace prefix (eg. `com.wix.metasite.FlashSite`)

#### google.protobuf.Any.pack<T>(ctor: \<generated-type-T\>, instance: T): google.protobuf.Any (static method)
Given type constructor and value creates instance of `google.protobuf.Any` with packed type & instance.

#### google.protobuf.Any.isAny(instance: object): boolean (static method)
Checks if given `instance` is instance of `google.protobuf.Any`

### REST support
REST support is currently limited to rendering the JSON representation of [Any](https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/any.proto) instead of the
actual unpacked value:

```json
{
    "typeUrl": "type.googleapis.com/com.wix.metasite.FlashSite",
    "value": "<base64 encoding of protobuf binary for FlashSite>"
}
```

### Generated Message Type Conversion

When sending or receiving messages in 1 of our 2 transports - JSON-RPC and gRPC - we use the classes generated by `wix-proto-codegen`.  
To convert the messages from "User" to "Wire" formats we have `@wix/wix-protobuf-converters` which implements the `Converter` interface for a `GeneratedMessage`

More info @ 
[`@wix/wix-protobuf-converters`](https://github.com/wix-platform/wix-node-platform/tree/master/rpc/wix-protobuf-converters)
