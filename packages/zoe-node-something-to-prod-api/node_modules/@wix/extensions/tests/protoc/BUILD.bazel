load("@server_infra//framework/protos/rules:protoc.bzl", "protoc")
load("@bazel_tools//tools/build_rules:test_rules.bzl", "file_test")

java_binary(
    name = "Plugin",
    srcs = ["Plugin.java"],
    main_class = "framework.protos.tests.protoc.Plugin",
    deps = ["@com_google_protobuf_protobuf_java"],
)

proto_library(
    name = "test_proto",
    srcs = [":test.proto"],
    strip_import_prefix = "/framework/protos",
    deps = ["@com_google_protobuf//:any_proto"],
)

protoc(
    name = "test_output",
    srcs = [":test_proto"],
    outs = "test_output.zip",
    opts = ["test_opt"],
    plugin = ":Plugin",
)

genrule(
    name = "test_output_content",
    srcs = [":test_output"],
    outs = ["test_output_content.txt"],
    cmd = "zipinfo -1 $(location :test_output) > $@",
)

file_test(
    name = "protoc_test",
    content = "test_opt\ntests/protoc/test.proto\n",
    file = ":test_output_content",
)
