syntax = "proto2";

package wix.sdk;

import "google/protobuf/descriptor.proto";

option java_multiple_files = true;
option java_outer_classname = "DefinitionsProto";
option java_package = "com.wix.sdk";


/**
logic of signature generation:
==============================

1) `id` (path-param) should be the first argument.
2) if there are more identifiers (path-params), a parent object called `identifiers` containing those will be the first argument.
3) first payload member will be the second argument unless overridden via proto option. in case of override, args will be taken from override option value in-order.
4) rest of arguments (if exist) will follow under the `options` parent.

internal logic for `identifiers` field:
take all path-params, merge with all `unique` fields, distinct.
if you have total args > 1 -> put all in `identifiers` parent.
otherwise - use single (usually id) arg as is and make it the first param.

`sdk.signature.params` cannot control neither `options` (last param) nor `id`/`identifiers` (first param) as those are needed by convention in Velo.


Examples:
=========

  // Example-1: Default behavior, single identifier:
  message GetProductRequest {
    option (.wix.api.unique) = {field: "id"}; //not needed, automatically assumed
    string id = 1;
    string product_family = 2;
    bool include_pii = 3;
  }
  rpc GetProduct (GetProductRequest) returns (GetProductResponse) {
    option (google.api.http) = {
      get = "/v1/products/{id}"
    };
    // ...
  }
  // Resulted signature: getProduct(id: string, productFamily: string, options: {includePii: boolean}) Product {...}
  {
    sdkSignatures: [
      {
        args: [
          {
            field: {
              path: "id"  <-- field name in proto request message
            }
          },
          {
            field: {
              path: "productFamily"  <-- field name in proto request message
            }
          },
          parent: {
            name: "options"
            fields: [
              {
                path: "includePii" <-- field name in proto request message
              }
            ]
          }
        ]
      }
    ]
  }

  // Example-2: Default behavior, multiple identifiers:
    message GetProductRequest {
      option (.wix.api.unique) = {
        field: "catalogId"
        field: "productId"
      };
      string catalogId = 1;
      string productId = 2;
      string product_family = 3;
      bool include_pii = 4;
    }
  rpc GetProduct (GetProductRequest) returns (GetProductResponse) {
    option (google.api.http) = {
      get = "/v1/catalog/{catalogId}/products/{productId}"
    };
    // ...
  }
  // Resulted signature: getProduct(identifiers: {catalogId: string, productId: string}, productFamily: string, options: {includePii: boolean}) Product {...}
  // schema response:
  {
    sdkSignatures: [
      {
        args: [
          {
            parent: {
              name: "identifiers"
              fields: [
                {
                  path: "catalogId"  <-- field name in proto request message
                },
                {
                  path: "productId" <-- field name in proto request message
                },
              ]
            }
          },
          {
            field: {
              path: "productFamily" <-- field name in proto request message
            }
          },
          parent: {
            name: "options"
            fields: [
              {
                path: "includePii" <-- field name in proto request message
              }
            ]
          }
        ]
      }
    ]
  }

  // Example-3: Using override option, multiple identifiers:
    message GetProductRequest {
      option (.wix.api.unique) = {
        field: "catalogId"
        field: "productId"
      };
      string catalogId = 1;
      string productId = 2;
      string product_family = 3;
      bool include_pii = 4;
    }
  rpc GetProduct (GetProductRequest) returns (GetProductResponse) {
    option (google.api.http) = {
      get = "/v1/catalog/{catalogId}/products/{productId}"
    };
    option (.wix.sdk.signature) = {
      params = "include_pii" // the rest will be auto wired to options arg
    };
    // ...
  }
  // Resulted signature: getProduct(identifiers: {catalogId: string, productId: string}, includePii: boolean, options: {productFamily: string}) Product {...}
  // schema response:
  {
    sdkSignatures: [
      {
        args: [
          {
            parent: {
              name: "identifiers"
              fields: [
                {
                  path: "catalogId"  <-- field name in proto request message
                },
                {
                  path: "productId" <-- field name in proto request message
                }
              ]
            }
          },
          {
            field: {
              path: "includePii" <-- field name in proto request message
            }
          },
          parent: {
            name: "options"
            fields: [
              {
                path: "productFamily" <-- field name in proto request message
              }
            ]
          }
        ]
      }
    ]
  }
**/

extend google.protobuf.MethodOptions {
  repeated Signature signature = 60100;
}

message Signature {
  repeated string params = 1;
}
