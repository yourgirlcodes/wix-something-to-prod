load("//framework/protos/rules:protoc.bzl", "protoc")
load("@server_infra//framework/protos:well_known_protos.bzl", "GOOGLE_API_PROTOS", "PROTOBUF_PROTOS")
load("@rules_pkg//:pkg.bzl", "pkg_tar")
load("@bazel_tooling//rules/proto_artifact_info/src/main:proto_artifact_info.bzl", "proto_artifact_info")
load("@server_infra//framework/protos/src/main/proto:internal.bzl", "framework_proto_library")

package(default_visibility = ["//visibility:public"])

_framework_proto_library = [
    "api",
    "http",
    "sdk",
    "spi",
]

[
    framework_proto_library(i)
    for i in _framework_proto_library
]

proto_artifact_info(
    name = "proto_artifact_info",
    coordinates = "com.wixpress.grpc:extensions",
    proto_libraries = [":%s_proto" % i for i in _framework_proto_library],
    proto_sources = "proto_sources.tar.gz",
    tags = ["proto_artifact_info"],
)

protoc(
    name = "google_api_proto_scala_srcjar",
    srcs = GOOGLE_API_PROTOS,
    outs = "google_api_proto_scala.srcjar",
    opts = ["no_lenses"],
    plugin = "//framework/protos/rules:ScalaPBPlugin",
)

scala_library(
    name = "google_api_proto_scala",
    srcs = [":google_api_proto_scala_srcjar"],
    expect_java_output = False,
    scalacopts = framework_scalac_opts(),
    deps = [
        "@com_google_protobuf_protobuf_java",
        "@com_thesamet_scalapb_lenses_2_12",
        "@com_thesamet_scalapb_scalapb_runtime_2_12",
    ],
)

# All of the below are hacks and should be removed

#################
### hack for CI bash parser
### see impl at https://github.com/wix-private/wix-ci/blob/master/ci-scripts/wix-general-scripts/src/proto/proto_gen_package
#
# group_id = "com.wixpress.grpc"
# artifact_id = "extensions"
#
### end hack
#################

pkg_tar(
    name = "proto_sources",
    srcs = glob([
        "wix/api/*.proto",
        "wix/http/*.proto",
        "wix/spi/*.proto",
    ]),
    extension = "tar.gz",
    strip_prefix = "/" + package_name(),
)

_exports = [":%s_proto_scala" % i for i in _framework_proto_library]

_deprecation = "use fine grain targets: %s" % ", ".join(_exports)

scala_import(
    name = "wix_api_proto_scala",
    deprecation = _deprecation,
    exports = _exports,
)

scala_import(
    name = "proto_scala",
    deprecation = _deprecation + ", :google_api_proto_scala",
    exports = [
        ":google_api_proto_scala",
        ":wix_api_proto_scala",
    ],
)
