import {createFlyntPluginsCliHost, createFlyntPluginsHost, PluginsCliHost, PluginsHost} from '@wix/flynt-plugins-host';
import {FlyntPlugin} from '@wix/flynt-plugin-types';
import {CliOptions} from './flynt-cli';
import debug from 'debug';
import {reportError} from './error-reporter';

export async function loadPluginsFromCli(args: string[]): Promise<PluginsCliHost> {
  const pluginsHost = createFlyntPluginsCliHost();
  await pluginsHost.loadPluginsFromCli(args);
  return pluginsHost;
}

export async function loadPluginsFromApi(plugins: FlyntPlugin[] | undefined): Promise<PluginsHost> {
  const pluginsHost = createFlyntPluginsHost();
  if (plugins) {
    for (const plugin of plugins) {
      await pluginsHost.loadPlugin(plugin);
    }
  }
  return pluginsHost;
}

export async function initPluginsRunner(pluginsHost: PluginsHost, opts: CliOptions) {
  const flyntPlugins = pluginsHost.createPluginsRunner({
    opts,
    debug: debug('wix:flynt:plugins'),
    async reportError(error: unknown): Promise<void> {
      await reportError(error);
    }
  });
  await flyntPlugins.init();
  return flyntPlugins;
}
