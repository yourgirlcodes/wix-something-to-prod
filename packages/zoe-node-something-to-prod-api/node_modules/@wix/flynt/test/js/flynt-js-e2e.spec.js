const tmp = require('tmp');
const fs = require('fs');

//This test helps finds issues with wrong imports
//which typescript allows but eventually fail in prod code
describe('flynt - js', () => {
  const moduleRootFolder = './test/resources/complex-module';
  const mainProtoFolder = './test/resources/complex-module/src/main/proto';
  const includeProtoFolder = [
    './test/resources/complex-module/protos-common/src/main/proto',
    './test/resources/complex-module/protos-query/src/main/proto',
    './test/resources/complex-module/site-properties-api-proto/src/main/proto',
    './test/resources/complex-module/locations-web/proto',
    './test/resources/complex-module/common-api/src/main/proto',
    './test/resources/complex-module/schedule-api/src/main/proto',
  ];

  it('runs flynt', async () => {
    // eslint-disable-next-line node/no-missing-require
    const {flynt} = require('../..');
    const {name: jsonOutput} = tmp.fileSync({postfix: 'output.json'});
    const results = await flynt({
      mainProtoFolder,
      includeProtoFolder,
      moduleRootFolder,
      jsonOutput,
    });
    const stdout = results.formattedOutput;
    console.log(stdout);
    const report = JSON.parse(fs.readFileSync(jsonOutput, 'utf-8'));
    expect(report.lintResults.executionErrors).toHaveLength(0);
  });
});
