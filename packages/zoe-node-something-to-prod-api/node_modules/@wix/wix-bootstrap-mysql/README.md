# wix-bootstrap-mysql
[wix-bootstrap-ng](https://github.com/wix-platform/wix-node-platform/tree/master/bootstrap) plugin for using [mysql](https://github.com/mysqljs/mysql#introduction)
(mysql client for node.js).

Handles the following aspects:
- mysql connection pool creation using the configuration [injected by chef](../wnp-bootstrap-mysql-config-template/templates/wix-bootstrap-mysql.xml.erb).
- health checks for created connection pool
- metrics reporting: 
  - query execution - counter and duration `tag=METER.db_type=mysql.db_name=[the database name].connection_type=[ro/rw].action=query`
  - connection pool - limit, active, awaiting

See the [sample-app](../wix-bootstrap-mysql-test-app) for a complete example.

## Install

```bash
npm install --save @wix/wix-bootstrap-mysql
```

## Usage

**index.js**
```js
bootstrap()
  .use(require('@wix/wix-bootstrap-mysql'))
  .config('./lib/config.js')
  .start();
```

**index.ts**
```ts
import * as mySql from '@wix/wix-bootstrap-mysql'

bootstrap()
  .use(mySql)
  .config('./lib/config.js')
  .start();
```
>if your `tsconfig.json` file has `"allowSyntheticDefaultImports": true` then you can just use `import mySql from '@wix/wix-bootstrap-mysql'`

**config.js**
```js
const dbClient = context.mysql.client('test-db');
```

**code.js**
```js
// Usage in the code
dbClient.queryAsync('SELECT name FROM `pets`')
    .then(/*...*/)
    .catch(/*...*/)
```

## API

### context.mysql.client(dbName, opts): DBClient

Create a new instance of mysql client.

Parameters:

- dbName (String) - database name.
- opts (Object, optional):
  - readOnly (Boolean, default: `false`) - whether to use read only connection (slave) or not (master).
  - maxLifetime (Number, millis) - if provided, controls the maximum lifetime of a connection in the pool. An in-use connection will never be retired, only when it is closed will it then be removed. Valid values are [5000..1800000] - 5 seconds to half hour range inclusive.
  - multipleStatements (Boolean, default: `false`) - if provided, Allow multiple mysql statements per query. Be careful with this, it could increase the scope of SQL injection attacks.
  - charset (String, default: `UTF8_GENERAL_CI`) - charset/collation to use for a connection. 
  - cluster (String) - in case multiple dbs being used by the artifact, the cluster name must be provided. Otherwise, it's ignored. Read more about [multiple dbs](#multiple-dbs).


Returns:

`DBClient` instance.

### DBClient.queryPromise(query): Promise

_alias_ `DBClient.queryAsync(query): Promise`

Make a query to MySQL server

Parameters:

* query (String) â€” SQL query.

Returns:

Promise which will be resolved with query result or rejected with error.

## Multiple DBs

In some case, there are multiple dbs being accessed by the artifact. In such case, in order to connect to a specific db, you must provide the `cluster` option in addition:

```js
const newDbClient = context.mysql.client('test-db', { cluster: 'my-new-cluster' });

const oldDbClient = context.mysql.client('test-db', { cluster: 'my-old-cluster' });
```

Don't you know what the cluster name is? please ask DBAs on [#db](https://wix.slack.com/archives/C0E3MBAGH) channel. You can also check the generated XML config (`wix-bootstrap-mysql.xml`) in production:

```xml
<?xml version="1.0"?>
<configuration>
  <readOnly>
    <database>
      <classifier>cluster 1</classifier>
      <host>dbproxy-mysql.42.wixprod.net</host>
      <port>3306</port>
      <username>user</username>
      <password secret="true">XXXXXX</password>
    </database>
    <database>
      <classifier>cluster 2</classifier>
      <host>pdbproxy-mysql.42.wixprod.net</host>
      <port>3306</port>
      <username>user</username>
      <password secret="true">XXXXXX</password>
    </database>
  </readOnly>
  <readWrite>
    <database>
      <classifier>cluster 1</classifier>
      <host>dbproxy-mysql.42.wixprod.net</host>
      <port>3306</port>
      <username>user</username>
      <password secret="true">XXXXXX</password>
    </database>
    <database>
      <classifier>cluster 2</classifier>
      <host>pdbproxy-mysql.42.wixprod.net</host>
      <port>3306</port>
      <username>user</username>
      <password secret="true">XXXXXXX</password>
    </database>
  </readWrite>
</configuration>
```

The cluster name is defined under the `classifier` element.

## Health Checks
This plugin by default registers two health checks for each [client](#contextmysqlclientdbname-opts-dbclient) you create:
- Running a health check query on the mySQL connection pool initialized by the plugin
- Running the same query on a fresh connection


In case your dependency on mysql is "soft", you can disable the health checks completely via the plugin option:

```ts
import * as mySql from '@wix/wix-bootstrap-mysql'

bootstrap()
  .use(mySql, {disableHealthChecks: true})
  .config('./lib/config.js')
  .start();
```
