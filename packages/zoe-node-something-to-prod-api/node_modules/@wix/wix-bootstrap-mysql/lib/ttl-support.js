const createdAt = Symbol('createdAt'),
  {MIN_TTL_IN_MILLIS} = require('./constants');

function addTtlSupport(pool, ttlInMillis) {

  pool.on('connection', con => {
    con[createdAt] = Date.now();
  });

  const _getConnection = pool.getConnection;
  const _end = pool.end;

  const interval = setInterval(removeExpiredConnections, MIN_TTL_IN_MILLIS);

  pool.getConnection = function (cb) {
    removeExpiredConnections();
    _getConnection.call(pool, cb);
  };

  pool.end = function (cb) {
    // untested. without clearing node process is stuck
    clearInterval(interval);
    _end.call(pool, cb);
  };

  function removeExpiredConnections() {
    const now = Date.now();
    const expired = [...pool._freeConnections.filter(c => now - c[createdAt] > ttlInMillis)];
    expired.forEach(c => c.destroy());
  }
}

module.exports = addTtlSupport;