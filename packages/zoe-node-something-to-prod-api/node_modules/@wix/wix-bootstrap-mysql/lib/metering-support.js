const WixMeasuredMetering = require('@wix/wix-measured-metering');
const {WIX_METERING_START_SYMBOL} = require('./constants');


function addMeteringSupport(pool, meteringClient, readOnly, dbName) {
  const poolMetrics = meteringClient
    .collection('db_type', 'mysql')
    .collection('db_name', dbName)
    .collection('connection_type', (readOnly) ? 'ro' : 'rw');

  const metering = new WixMeasuredMetering(poolMetrics);

  const rawMetering = metering.raw('action', 'query');

  let activeCount = 0;

  pool.on('acquire', connection => {
    activeCount++;
    connection[WIX_METERING_START_SYMBOL] = Date.now();
  });

  pool.on('release', connection => {
    if (connection[WIX_METERING_START_SYMBOL]) {
      const duration = Date.now() - connection[WIX_METERING_START_SYMBOL];
      rawMetering.reportSuccess({duration});
      delete connection[WIX_METERING_START_SYMBOL];
    }
    activeCount--;
  });

  poolMetrics.gauge('pool-limit')(() => pool.config.connectionLimit);
  poolMetrics.gauge('pool-active')(() => activeCount);

  // cannot use 'enqueue' event due to inability to link between enqueue and acquire events
  poolMetrics.gauge('pool-waiting')(() => pool._connectionQueue && pool._connectionQueue.length || 0);
}

module.exports = addMeteringSupport;
