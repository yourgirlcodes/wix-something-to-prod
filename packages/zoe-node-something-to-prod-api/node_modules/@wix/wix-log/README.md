# wix-log

**NOTE:** this module is intended to be used within [bootstrap applications](../../bootstrap/wix-bootstrap-ng) only!

For other use cases please use [@wix/wix-debug](../wix-debug).


Simple wrapper on top of [debug](https://www.npmjs.com/package/debug) with features:
 - normalizes log key to be of `wix:` format;
 - provides info/error/debug/trace functions with corresponding infix;
 - coerces error objects within log arguments.
 - writes [Superlogs](#superlogs)  
 - logging data to [Kibana](#kibana) logging system [**DEPRECATED**].

## migration scripts from @wix/wix-debug to @wix/wix-log (MacOS)

_package.json_

`find . -type f -name "package.json" ! -path "*/node_modules/*" -exec sed -i '' -E 's/"@wix\/wix-debug": ".+"/"@wix\/wix-log": "latest"/' {} +`

_js,ts sources_

`find . -type f \( -name "*.js" -o -name "*.ts" \) ! -path "*/node_modules/*" -exec sed -i '' -E 's/@wix\/wix-debug/@wix\/wix-log/' {} +`

## Install

```js
npm install --save @wix/wix-log
```

## Usage

```js
const log = require('@wix/wix-log')('some-module')

log.info('info msg'); //logs to stderr with key wnp:info:some-module.

log.error(new Error('woops')); //logs to stderr with key wnp:error:some-module.
```

NOTE: underlying [debug](https://www.npmjs.com/package/debug) logger instances are cached by name, therefore you should not create
loggers with unique names, otherwise  you'll get a memory leak.

## Superlogs 
In order to support - [Superlogs](https://github.com/wix-private/wix-monitoring/blob/master/docs/logging.md) - new cross Wix logging approach 
a new log file will be generated in Production environment - `APP-NAME-HERE_[pid]_logstash_json.log`. This file will be automatically collected and the logs will be accessible via [Grafana](https://grafana.wixpress.com/d/yLVQPrzMz/app-analytics?orgId=1) or [Redash](http://redash.wixpress.com/) (check the [Clickhouse query syntax](https://clickhouse.tech/docs/en/sql-reference/statements/select/) for the latter).
The collected schemas are described [here](https://github.com/wix-system/clickhouse-writer/blob/master/Readme.md#logs-schemas).

This behaviour is **in addition** to the existing one - current logs should not be affected by it.

**IMPORTANT!** Having said that, it's important to understand that there are few constraints for logged entry to be added to the log file: 
 - It is highly recommended creating a logger using **valid aspects** (via [withAspects](#wixloggerwithaspectsaspects-aspectstore-wixlogger)/[withRequest](#wixloggerwithrequestexpressrequestobject-wixlogger) methods) - some data is extracted and added to the log automatically in this case (like requestId, user info, etc.). Otherwise, all that data will be missing in logs which will make searching/indexing it less useful.
 - In addition, it is possible to further create a logger using [withData] - data passed is added to every log call automatically.
 - The API is more strict when the _Superlogs_ are enabled:
   - the usage of deprecated APIs (accepting any args) could result in unexpected log entries
     - the string formatting API - `log.debug('Name is %s', name)` - is not supported! It is recommended to have a short message and to take all the parameters to the `data` property (see below)
   - for non-error logs (`log.warn`, `log.info`, `log.debug`, `log.race`) 
     - the first argument should be a string - mapped to the `message` property in log entry. 
     - the second argument can be a serialisable object - mapped to the `data` property in log entry.
     - any additional arguments will be merged into the `data` property
     - any non-object arguments will be added to the `data` property under a key `argN` where `N` is the argument counter
     - [backward compatibility] supporting JSON-like API - `log.debug(obj)` when `obj` is an `Object` then:
       - `obj` will be mapped to the `data` property
       - if `obj.message` is defined - it will be mapped to the `message` property 
   - for error logs (`log.error`)
     - the first argument is expected to be string or an instance of `Error` - mapped to the `message` property in log entry. 
     - if the first argument was string, the second argument is expected to be an instance of `Error` 
     - the `stack_trace` property is taken from the instance of `Error`, as well as the `error_class` property
     - any additional arguments are merged and mapped to the `data` property - same logic as for the app log.
     - [backward compatibility] supporting JSON-like API - `log.error(obj)` when `obj` is an `Object` (and not an instance of `Error`) then:
       - `obj` will be mapped to the `data` property
       - if `obj.message` is defined - it will be mapped to the `message` property 
     
 - The value of the `DEBUG` env variable does not affect/filter entries written to the log file
 - Only the entries with a log level equal or more "important" than the one configured via [WNP_SUPER_APP_LOG_LEVEL](../../composer/wnp-bootstrap-composer) env variable will be added. (The default level is `INFO`)
 - The log file is **not created in dev environment** by default (could be enabled by `WNP_FILES_LOGGER_IN_DEV_MODE` env variable) 
 - The Superlogs are only available with a **bootstrap** application (during the initialization bootstrap code configures mandatory parts to enable superlogs logging)
 
 Usage example:
 ```
 const log = require('@wix/wix-log')('some-module')

 // All the enties with aspects will be logged into the log file -> APP-NAME-HERE_[pid]_logstash_json.log

 log.info('info msg'); // No aspects - will be logged into the superlogs system but without any data about the request

 //   "hello" mapped to MESSAGE property
 log.withAspects(aspects).info('hello');            
 
 //   "hello" mapped to MESSAGE property
 //   the rest arguments mapped to DATA property
 log.withRequest(req).info('hello', {someId: 123, someName: 'foo'});  
 
 //   the first arguments mapped to DATA property
 //   "hello" mapped to MESSAGE property
 log.withRequest(req).info({someId: 123, someName: 'foo', message: 'hello'});  
 
 //   "Boom" mapped to MESSAGE property, stack trace taken from the Error
 log.withAspects(aspects).error(new Error('Boom'));    
 
 //   "Big boom" mapped to MESSAGE property, stack trace taken from the Error
 log.withAspects(aspects).error('Big boom!', new Error('boom'));    
```

### Superlogs FAQ
 - **I cannot see my artifact in the drop down list in Grafana. What should I do?**
   - the drop down is populated by actual existing logs - make sure you actually have anything logged with appropriate log level 
   - the default APP log level is `INFO` - the `log.debug(...)` entries will not be visible by default
   - make sure you get the expected traffic for the logging code to be executed - use Grafana/Relic
   - check that superlog files exist on the pod  
   
 - **How do I check that the log files do exist on the pod?**
   - [connect](../../bootstrap/docs/production.md#kubernetes-k8s-environment) to one of app pods and verify the following file exists in the `/logs` folder:
     - `YOUR-APP-NAME-HERE_[pid]_logstash_json.log`
     
 - **Kibana logs and Superlogs does not exactly match. Why?**
   - Kibana logs are based on a different source file (`stderr.log`) and the data could be not exactly the same
   - if you think the mismatch suggests a bug - please contact us in #node-platform Slack channel
   
 - **I have problems querying `logs_db.app_logs` in Redash?**
   - use [#logging](https://wix.slack.com/archives/C4F64HDH9) Slack channel for support on [Redash](http://redash.wixpress.com/)
    

# Api
## (name, prefixesArray): DebugLogger
```js
const debug = require('@wix/wix-log');
const logger = debug(name);
```
Returns logger instance, where key will be:
 - `name` prefixes `wix-` or `wix-` will be replaced with `wix:`;
 - `name` prefixes `wix:` will be left intact;
 - otherwise `name` will be prefixed with `wix:`;
 - `prefixes` will be added in front of log information


Examples:
 - debug('name').info('woop') -> 'wix:info:name woop';
 - debug('wix-name').debug('woop') -> 'wix:debug:name woop';
 - debug('wix:name').info('woop') -> 'wix:info:name woop';
 - debug('name', ['prefix', 'pre']).info('woop') -> 'wix:info:name prefix pre woop';

## Logger
`DebugLogger` class for extending or testing.

## WixLogger.withAspects(aspects: [AspectStore](../../aspects/wix-aspects)): WixLogger
 Returns new logger instance with that provides additional request information
  - logs out request id in form of `[requestId: <id>]`

In the **production** environment (or when forced by `WNP_FILES_LOGGER_IN_DEV_MODE=true` env variable), the returned logger is composite and contains in addition
an instance of [wnp-files-log](../wnp-files-log) that generates log files in JSON superlog format.<br/>

## WixLogger.withRequest(expressRequestObject): WixLogger
Delegate call to the `withAspects` method with the request's aspects (`req.aspects`) - see description above.

## WixLogger.withData(data: object): WixLogger
Returns new logger instance that appends `data` passed into every log message written. The `data` argument is expected to be an object (map of properties). 

```javascript
const logger = require('@wix/wix-log')('my-logger');

const loggerWithData = logger.withData({'common': 'something-common'});

// The following 2 calls are equivalent:
loggerWithData.info('Hello', {'call': 'specific detail'}); 
logger.info('Hello', {'common': 'something-common', 'call': 'specific detail'}); 
```

## WixLogger.trace(arguments)
**DEPRECATED** Use more specific signature accepting message as the first argument - see details [below](#methods)

Logs message to stderr with 'trace' infix.

## WixLogger.debug(arguments)
**DEPRECATED** Use more specific signature accepting message as the first argument - see details [below](#methods)

Logs message to stderr with 'debug' infix.

## WixLogger.info(arguments)
**DEPRECATED** Use more specific signature accepting message as the first argument - see details [below](#methods)

Logs message to stderr with 'info' infix.

## WixLogger.warn(arguments)
**DEPRECATED** Use more specific signature accepting message as the first argument - see details [below](#methods)

Logs message to stderr with 'warn' infix.

<a name="methods"></a>
## WixLogger.[trace, debug, info, warn](message, ...arguments)
Logs message with the appropriate infix. In the Superlogs mode (when the logger is configure with an aspects store) the message is also logged
into the **application log file** in the JSON format with the following logic:
 - the first argument is taken to the `message` property
 - any further arguments are accumulated into the `data` property

## WixLogger.error(arguments)
**DEPRECATED** Use more specific signature accepting message or Error as the first argument - see [error](#error)

Logs message to stderr with 'error' infix.

<a name="error"></a>
## WixLogger.error(messageOrError, errorOrAny, ...arguments)
Logs message with the `error` infix. In the Superlogs mode (when the logger is configure with an aspects store) the message is also logged
into the **error log file** in the JSON format with the following logic:
 - the first argument is taken to the `message` property
 - if the first or the second argument is an instance of `Error`
   - the `stack` property is set accordingly
   - the `error_class` property is set to the name of the error constructor
 - any further arguments are accumulated into the `data` property



## Logging with JSON output
For logging data from production environment in a JSON format (e.g. to allow viewing in Kibana [**DEPRECATED**]) you should set the following [ENV variables](https://github.com/wix-a/debug-no-namespace#environment-variables):
```bash
JSON_STDOUT='enabled'
DEBUG_HIDE_NAMESPACE='enabled'
DEBUG_HIDE_DATE='enabled'
```

### Kibana

------------------------
**DEPRECATED!** Using _Kibana_ is deprecated by the System (Monitoring team). The following instructions might not work  - fully or partially! Use the [#logging](https://wix.slack.com/archives/C4F64HDH9) Slack channel for support!  

------------------------


To make your logs be visible in Kibana, you also need to configure a collection pipeline for your logs. Follow the [instructions](https://system-kb.wixanswers.com/en/article/wix-log-manager) in the System's knowledge base to do that.<br/>
Use the following file paths there:
```
/var/log/YOUR_ARTIFACT/stderr.log,/var/log/wix/YOUR_ARTIFACT/stderr.log
```
where `YOUR_ARTIFACT` is the full artifact name (eg. _com.wixpress.npm.das-boot-ng_)

**WARNING**: If you used to have a solution based on `log_pipelines.json.erb` file, you need to migrate to the new logs collector (see instructions above). The `log_pipelines.json.erb`-based solution is deprecated and is not supported in Kubernetes environment.

### Infra properties
When logging, some system data will be automatically added under the `infra` property - like application name, data center, etc. This replacing deprecated system properties added with leading _ (`_appName`, `_dc`, etc.) that were not indexable in Kibana.

Example:
```json
{
  "_appName":"com.wixpress.npm.your-artifact-id","
  _hostName":"some-docker-host.wixprod.net",
  "infra": {
    "appName":"com.wixpress.npm.your-artifact-id",
    "hostName":"some-docker-host.wixprod.net",
    "dc": "42"
  }
}
```

### Use `wix-log` module with arguments like `object`, `array` or `string`
#### Object:
Please don't use the keys of object: `_appName`, `_hostName`, `timestamp`, `infra`.
`_appName` and `_hostName` are already used by data from `process.env['APP_NAME']` and `process.env['HOSTNAME']`.
`timestamp` is the log time.
`infra` is used to report data about your app (like `appName` and `hostName`).
In this case you will got the error and your data will be in `text` key.

```js
const wixDebug = require('@wix/wix-log');
const debug = wixDebug('pix');
debug.error({ customParam: 'hello' });
```

The result:
```json
{
  "_appName":"com.wixpress.npm.your-artifact-id",
  "_hostName":"some-docker-host.wixprod.net",
  "infra": {
    "appName":"com.wixpress.npm.your-artifact-id",
    "hostName":"some-docker-host.wixprod.net"
  },
  "timestamp":"2018-06-14T13:29:38.741Z",
  "customParam":"hello"
}
```

#### Array:
```js
const wixDebug = require('@wix/wix-log');
const debug = wixDebug('pix');
debug.error([1, 2, 3, 4]);
```

The result:
```json
{
  "_appName":"com.wixpress.npm.your-artifact-id",
  "_hostName":"some-docker-host.wixprod.net",
  "infra": {
    "appName":"com.wixpress.npm.your-artifact-id",
    "hostName":"some-docker-host.wixprod.net"
  },
  "timestamp":"2018-06-14T13:29:12.655Z",
  "text":"[1,2,3,4]"
}
```


#### String:
```js
const wixDebug = require('@wix/wix-log');
const debug = wixDebug('pix');
debug.error('some-error-message');
```

The result:
```json
{
  "_appName":"com.wixpress.npm.your-artifact-id",
  "_hostName":"some-docker-host.wixprod.net",
  "infra": {
    "appName":"com.wixpress.npm.your-artifact-id",
    "hostName":"some-docker-host.wixprod.net"
  },
  "timestamp":"2018-06-14T13:30:27.304Z",
  "text":"some-error-message"
}
```


#### Error:
```js
const wixDebug = require('@wix/wix-log');
const debug = wixDebug('pix');
debug.error(new Error('custom-error'));
```

The result:
```json
{
  "_appName":"com.wixpress.npm.your-artifact-id",
  "_hostName":"some-docker-host.wixprod.net",
  "infra": {
    "appName":"com.wixpress.npm.your-artifact-id",
    "hostName":"some-docker-host.wixprod.net"
  },
  "timestamp":"2020-04-03T15:20:07.643Z",
  "errorData": {
    "message":"custom-error",
    "name":"Error",
    "stack":"Error: custom-error\n    at methodWhichThrowsError ... full stack trace ..."
  },
  "message":"custom-error"
}
```
**Note:** If the error has property `_doNotLogStackTrace = true`, stack trace will be suppressed. So stack from example above will be:
```
... , "stack":"Error: custom-error", ...
```

Data from `debug.*` with additional data(app name, host name, timestamp) will be stringified to JSON and passed to logging system.


# Testing
Use [`@wix/wix-stdouterr-testkit`](../../testing/wix-stdouterr-testkit) to test usage of wix-log:
```typescript
import testkit from '@wix/wix-stdouterr-testkit';
import {expect} from 'chai';
import WixLog from '@wix/wix-log';

const log = WixLog('some-namespace');

describe('some', () => {
  const interceptor = testkit.interceptor().beforeAndAfterEach();

  it('logs an error in specific situation', () => {
    log.error('some error')

    expect(interceptor.stderr).to.match(/wix:error:some-namespace.*some error/);
  });
});
```


# Environment variables
 - `DEBUG_ENV_ONLY` - by default `wix-log` will enable logging **errors** for any namespace without taking into account the `DEBUG` variable. Setting `DEBUG_ENV_ONLY=true` will disable that, and logs will be written according to the value of `DEBUG` variable only.  
