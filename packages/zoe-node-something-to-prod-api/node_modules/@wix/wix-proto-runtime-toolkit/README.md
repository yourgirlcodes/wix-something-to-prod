# wix-proto-runtime-toolkit

Runtime support & tools to be used within RPC for the generated code via [wix-proto-codegen](../wix-proto-codegen).

**Note:** Conversions of _Generated Message types_ *to* and *from* _wire_ formats (`gRPC`/`JSON-RPC`) are done via `@wix/wix-protobuf-converters`.  
More info @ [`@wix/wix-protobuf-converters`](https://github.com/wix-platform/wix-node-platform/tree/master/rpc/wix-protobuf-converters)

## install

```
npm install --save @wix/wix-proto-runtime-toolkit
```

## Usage
```js
const toolkit = require('@wix/wix-proto-runtime-toolkit');

// verification of protobuf Map type keys
const isValid = toolkit.verification.Map.Key.isInt32('1234');

```

## API

### verification.Errors
Hierarchical error messages with fluent API, to be used in conjunction with the generated static `verify` method.

_usage:_
```js
const errors = Errors.empty()
  .field('firstName')
    .error('invalid')
    .up()
  .field('contactInfo')  
    .field('phoneNumbers')
      .index(1)
      .error('country code is missing')
      .toString();
  
// errors === 'firstName: invalid\ncontactInfo.phoneNumber[1]: country code is missing
```

#### Errors.empty(): Errors
Initializes an empty errors object

#### Errors#error(msg: string): Errors
Adds error message to current hierarchy

#### Errors#field(field: string): Errors
Adds hierarchy level with a given field

#### Errors#index(index: string | integer): Errors
Adds hierarchy level with a given index

#### Errors#up(): Errors
Goes up the hierarchy

#### Errors#toArray(): Array\<string\>
Returns an array of errors

#### Errors#toString(): string
Returns all errors concatenated

#### protobufjs
Instance of [@wix/wnp-protobufjs](../wnp-protobufjs).

### verification.Map.Key.isBoolean(key: string): boolean

### verification.Map.Key.isInt32(key: string): boolean

### <a name="tojson"></a>json.Duration.toJSON({seconds?: Long | number, nanos?: number}): string
Converts [`google.protobuf.Duration`](https://github.com/google/protobuf/blob/master/src/google/protobuf/duration.proto) \
to a valid string for JSON format as described [here](https://developers.google.com/protocol-buffers/docs/proto3#json).

### json.Duration.fromJSON(durationAsString: string): {seconds?: Long, nanos?: number}
The opposite of [`toJSON`](#tojson).

### grpc.fromGRPC(type: protobufjs.Type, message: object): object
Adapts gRPC message for given protobufjs Type to wix-proto-codegen message

### grpc.toGRPC(type: protobufjs.Type, message: object): object
Adapts wix-proto-codegen message for given protobufjs Type to gRPC message

### protobuf.encode(type: <generated>, value: object): Buffer
Converts given value using [`toGRPC`](#grpctogrpctype-protobufjstype-message-object-object) and encodes to protobuf.

### protobuf.decode(type: <generated>, buffer: Buffer): object
Decodes given buffer from protobuf and converts value using [`fromGRPC`](#grpcfromgrpctype-protobufjstype-message-object-object).

### util.interfaceClass(instanceOrClass): class
Resolves the generated RPC service interface for given subclass/instance.

### util.serviceMethods(instanceOrClass): {[methodName: string]: {messageTypes: [RequestMessageClass, ResponseMessageClass]}
Returns RPC service methods

### util.isRpcService(instanceOrClass): boolean

### util.isMessageClass(any): boolean
Returns _true_ if passed argument is a generated message class

### util.unimplementedMethods(instanceOrClass): string[]
Returns an array of unimplemented method names for given class/instance.

### util.options(namespace) => protobufjs.ReflectionObject => { find(pathOrRegex = /.*/, includeKeys = false): (string[] | string[][]) & { first?: string } }
Helper for querying `protobufjs.ReflectionObject#parsedOptions` with a fallback to `protobufjs.ReflectionObject#rawOptions` or `protobufjs.ReflectionObject#options`.

```javascript
const {util} = require('@wix/wix-proto-runtime-toolkit');

const root = require('@wix/wnp-protobufjs').loadSync('proto/my-service.proto');
const message = root.lookup('com.wix.MyService');
const options = util.options('google.api.http'); 
const route = options(message.methods['Foo']).find('additional_bindings').first;
``` 

### util.fqn(node: ReflectionObject | _GeneratedMessageClass_): string
Given a
[`ReflectionObject`](http://dcode.io/protobuf.js/ReflectionObject.html), calculates fully qualified name 
of the object, ie given proto file:

_ecom.proto_
```proto
package com.wix.ecom;

message Cart {
  // fields
}
```

```javascript
const type = protobuf.loadSync('ecom.proto').lookup('.com.wix.ecom.Cart');
assert(util.fqn(type) === 'com.wix.ecom.Cart');
```
