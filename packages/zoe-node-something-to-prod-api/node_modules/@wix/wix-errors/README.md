# wix-errors

This module defines base errors constructs. Among them `GrpcStatusError` exception class which should be thrown by protobuf-defined RPC services. This exception is
properly propagated via gRPC or protobuf-defined JSON RPC from Scala servers to Node.js clients and from Node.js servers to Scala clients.

## install

```shell
npm install --save @wix/wix-errors
```


## usage - `GrpcStatusError`
```js
const {GrpcStatusError, GrpcStatus} = require('@wix/wix-errors');

throw GrpcStatusError.applicationError(GrpcStatus.INVALID_ARGUMENT, 'message', {code: 'some_code', description: 'some description'});
```

# API

## GrpcStatus
An enumeration of gRPC [status codes](https://github.com/grpc/grpc/blob/master/doc/statuscodes.md):
```js
    OK = 0,
    CANCELLED = 1,
    UNKNOWN = 2,
    INVALID_ARGUMENT = 3,
    DEADLINE_EXCEEDED = 4,
    NOT_FOUND = 5,
    ALREADY_EXISTS = 6,
    PERMISSION_DENIED = 7,
    RESOURCE_EXHAUSTED = 8,
    FAILED_PRECONDITION = 9,
    ABORTED = 10,
    OUT_OF_RANGE = 11,
    UNIMPLEMENTED = 12,
    INTERNAL = 13,
    UNAVAILABLE = 14,
    DATA_LOSS = 15,
    UNAUTHENTICATED = 16
```                           

## GrpcStatus.toHttpStatus(grpcStatus: GrpcStatus): number;
Returns numeric HTTP status code for given `grpcStatus`.

## GrpcStatus.asString(code: string | number): string
Converts error code to readable name if passed a number representation, otherwise does nothing.

## GrpcStatus.asNumber(code: string | number): number
Converts error code to integer code if passed a string, otherwise does nothing.

## GrpcStatusError.applicationError

```typescript
interface GrpcStatusError {
  applicationError(options: ApplicationErrorOptions): GrpcStatusError;
  applicationError(
    code: GrpcStatus, 
    message: string, 
    applicationError: wix.api.ApplicationError, 
    name?: string
  ): GrpcStatusError;
}

interface ApplicationErrorOptions {
  code: GrpcStatus;
  message: string;
  applicationError: wix.api.ApplicationError;
  name?: string;
  cause?: Error;
}
```

A static factory method for platformized application errors as defined in [wix error API](https://github.com/wix-private/server-infra/blob/master/framework/protos/src/main/proto/wix/api/errors.proto).

Parameters: 
- **code | options.code** `GrpcStatus` - gRPC status code 
- **message | options.message** `string` - error description 
- **applicationError | options.applicationError** [`wix.api.ApplicationError`](https://github.com/wix-private/server-infra/blob/master/framework/protos/src/main/proto/wix/api/errors.proto#L18) - Application error details that includes code, description and extra data. 
- **name | options.name** `string` - _optional_ Visible name that will be reported to Newrelic
- **options.cause** `Error` - _optional_ Cause of error. It's stacktrace will be added to GrpcStatusError

## GrpcStatusError.validationError

```typescript
interface GrpcStatusError {
  validationError(options: ValidationErrorOptions): GrpcStatusError;
  validationError(
    code: GrpcStatus,
    message: string,
    validationError: wix.api.ValidationError
  ): GrpcStatusError;
}

interface ValidationErrorOptions {
  code: GrpcStatus;
  message: string;
  validationError: wix.api.ValidationError;
  cause?: Error;
}

```

A static factory method for platformized validation errors as defined in [wix error API](https://github.com/wix-private/server-infra/blob/master/framework/protos/src/main/proto/wix/api/errors.proto).

Parameters:
- **code | options.code** `GrpcStatus` - gRPC status code
- **message | options.message** `string` - Error description
- **validationError | options.validationError** [`wix.api.ValidationError`](https://github.com/wix-private/server-infra/blob/master/framework/protos/src/main/proto/wix/api/errors.proto#L56) - Validation error details that includes FieldViolation
- **options.cause** `Error` - _optional_ Cause of error. It's stacktrace will be added to GrpcStatusError

## GrpcStatusError.isInstance(error: any): boolean
Checks if the given `error` is an instance of `GrpcStatusError` or its subtype.

## new GrpcStatusError(code: string | number, message: string, metadata: {\[key: string\]: string | Buffer}, cause?: Error, name?: string)
Parameters:
 - `code` - gRPC status code
 - `message` - string description
 - `metadata` - an object that will be converted to gRPC metadata and sent as gRPC trailers. Keys must be valid gRPC trailer names
    (e.g. spaces are not allowed, see https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md for details).
    '-bin' suffix is added to binary trailer names automatically, so it must not be included.
    The values must be either strings or `Buffer`s for binary trailers. Multi-valued trailers are not supported.
    **Passing raw metadata is discouraged**, consider using `GrpcStatusError.applicationError` factory method.
 - `cause` - optional error cause
 - `name` - optional name to be used for Newrelic error reporting

## GrpcStatusError#details: wix.api.Details
Platformized error details, see [wix error API](https://github.com/wix-private/server-infra/blob/master/framework/protos/src/main/proto/wix/api/errors.proto).

## GrpcStatusError#callInfo?: CallInfo
Returns call info if available
```
type CallInfo = {
    readonly url: string,           // remote peer URL
    readonly service: string,       // service interface (eg com.wixpress.ecom.CheckoutService)
    readonly method: string         // service interface method
}
```

# WixBusinessError and WixSystemError
**NOTE**: use these only in your `express` applications. Protobuf-defined services should use `GrpcStatusError`.
Factory for your domain/system errors that play nicely with the platform plus a generic error class `WixError` that allows to
have nested `Error` cause instances and renders it in the stack trace.

The platform distinguishes between two types of errors:
- Business errors - extends `WixBusinessError` class; Those types of errors should designate your business
logic exceptional cases and should have their error messages safe for propagating to the client side.
- System errors - extends `WixSystemError` class; Those types of errors should be used for other error cases
(ie temporary unavailability of RPC endpoint/database/CPU/file system/NodeJS Lord etc).
 The messages of system error instances will not be revealed to the client side (but still will be available to monitoring systems aka NewRelic, logs etc).

## usage

```js
const {WixBusinessError, WixSystemError, WixError, HttpStatus} = require('@wix/wix-errors');

const MyUniqueErrorCode = -666;

// define your business error class
class MyAssetNotFoundError extends WixBusinessError {
  constructor(msg, cause) {
    super(msg, {cause, errorCode: MyUniqueErrorCode, httpStatusCode: HttpStatus.NOT_FOUND});
  }
}

// define your system error class
class MongodbWentBerserkError extends WixSystemError {
  constructor(cause) {
    /* defaults to errorCode of -100 and httpStatusCode of HttpStatus.INTERNAL_SERVER_ERROR */
    super('MongoDb has some issues', {cause});
  }
}

// in your domain logic
function findMyAssetById(myAssetId) {
    try {
      mongodb.myCollection.findById(myAssetId);
    } catch (cause) {
        if (cause instanceof mongodb.ObjectNotFound) {
            throw new MyAssetNotFoundError(`My asset with id ${myAssetId} not found`, cause);
        } else {
            throw new MongodbWentBerserkError(cause);
        }
    }
}

// or use a built-in WixError which is an instance of wixSystemError
function meantToFail2() {
    try {
        let theAnswer = 25 / 0;
    } catch(cause) {
      throw new WixError('oops I did it again', cause);
    }
}

```

# Api

## new WixError(message, cause)
Constructs an instance of `WixError` error with message and cause provided. WixError instances have
`errorCode` set to -100 (Unknown) and HTTP status code set to `HttpStatus.INTERNAL_SERVER_ERROR` (500).
- `message` - mandatory, valid string
- `cause` - opt, instance of `Error`

If you want to define other values for `errorCode` or HTTP status code, please use `wixErrorBase` class constructor (see below).

## WixBusinessError(msg, {cause, errorCode, httpStatusCode, escapeHtml}) | WixSystemError(msg, {cause, errorCode, httpStatusCode})
Classes to extend for your business/system errors.

Parameters:
 - `msg` - mandatory, message;
 - `cause` - optional, underlying error;
 - **deprecated** `errorCode` - optional, default is `-100` **this makes sense only for JSON-RPC, but JSON-RPC should be exposed via Protobuf IDL**
 - `httpStatusCode` optional, default is `HttpStatus.INTERNAL_SERVER_ERROR`
 - `escapeHtml` optional, default is `true`. Based on this parameter, the error handling middleware/mechanism should escape HTML tags in order to protect from XSS attack.

## extractMetadata(error): {name, errorCode, httpStatusCode, message, escapeHtml}
Returns metadata from Error that is safe to be displayed outside Wix - http, platform RPC, etc.
For example it will not `message` for `WixSystemError` or `WixError` or plain `Error` - as it is sensitive.

`extractMetadata` also respects [`http-errors`](https://www.npmjs.com/package/http-errors) with `httpStatusCode` and `message` exposure rules.

## isBusinessError(error): boolean
Returns true if given instance of `Error` object is of type `business`

## throwAsLocalError<T extends Error>(error: T): never
Marks `error` as _local error_ and rethrows it. See [Error Handling Guide](../../bootstrap/docs/error-handling.md) for details.

## Error matching helpers

```typescript
import {isGrpcStatusError, isValidationError, isApplicationError} from '@wix/wix-errors/match';
```

### isGrpcStatusError(err: any, expectedStatus?: GrpcStatus | GrpcStatus[]): err is GrpcStatusError;
### isValidationError(err: any): err is GrpcValidationError;
### isApplicationError(err: any, expectedErrorCode?: string | string[]): err is GrpcApplicationError;

See [Error Handling Guide](../../bootstrap/docs/error-handling.md) for details.
