const WixMeasured = require('./lib/wix-measured'),
  WixMeasuredRegistry = require('./lib/wix-measured-registry'),
  sanitize = require('./lib/sanitize'),
  logger = require('@wix/wix-log')('wix-measured'),
  assert = require('assert');

class WixMeasuredFactory {

  constructor(host, appName, log = logger) {
    assert(host && typeof host === 'string', 'host must be a string and is mandatory');
    assert(appName && typeof appName === 'string', 'appName must be a string and is mandatory');

    this._registry = new WixMeasuredRegistry({
      prefix: `root=node_app_info.host=${sanitize(host)}.app_name=${sanitize(appName)}`
    });
    this._log = log;
  }

  addReporter(reporter) {
    reporter.addTo(this._registry);
    return this;
  }

  collection(key, name) {
    let registry = this._registry;
    if (key && name) {
      registry = this._registry.forCollection(key, name);
    }
    return new WixMeasured({registry, log: this._log});
  }
}

module.exports = WixMeasuredFactory;
module.exports.default = WixMeasuredFactory;
