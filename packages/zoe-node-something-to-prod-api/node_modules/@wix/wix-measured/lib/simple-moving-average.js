const {units} = require('measured-core'),
  CircularBuffer = require('circular-buffer'),
  _ = require('lodash');

module.exports = class SimpleMovingAverage {

  constructor(timePeriod = units.MINUTES, tickInterval = 5 * units.SECONDS) {
    this._buckets = new CircularBuffer(timePeriod / tickInterval);
    this.timePeriod = timePeriod;
    this.tickInterval = tickInterval;
    this._currentBucket = 0;
  }

  tick() {
    this._buckets.enq(this._currentBucket);
    this._currentBucket = 0;
  }

  update(n) {
    this._currentBucket += n;
  }

  rate(timeUnit) {
    return this._sum / this.timePeriod * timeUnit;
  }

  get _sum() {
    const arr = this._buckets.toarray();
    arr.push(this._currentBucket);
    return _.sum(arr);
  }
};
