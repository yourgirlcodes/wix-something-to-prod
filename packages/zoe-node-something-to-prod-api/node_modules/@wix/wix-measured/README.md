# wix-measured

Metrics library with simplified api and adaptations towards wix infra.

## install

```bash
npm install --save @wix/wix-measured
```

## usage

```js
const WixStatsdReporter = require('@wix/wix-measured-statsd-reporter'),
  WixMeasuredFactory = require('@wix/wix-measured');

const measuredClient = new WixMeasuredFactory('localhost', 'anApp') //crete factory
    .addReporter(new WixStatsdReporter({host: 'sensu', interval: 2000})) //add statsd reporter
    .collection('collectionKey', 'collectionValue'); //create collection

measured.meter('reqPerSec')(20); //send meter of 10 for 'meter=reqPerSec'.

measured.gauge('random')(() => Math.round(Math.random() * 100));//send gauge for every reporter interval on key 'gauge=random'
```

## Api

### WixMeasuredFactory(host, appName): WixMeasuredFactory
constructor for WixMeasuredFactory.

Arguments:
  - host - string, mandatory, hostname of an app;
  - appName - string, mandatory, application name;
 
Given opts:
```js
const measured = new WixMeasuredFactory('local', 'my-app').collection('key', 'value');

measured.meter('reqPerSec')(10);
```

will result in statsd event with key `root=node_app_info.host=local.app_name=my_app.key=value.meter=reqPerSec`.

### WixMeasuredFactory.addReporter(reporter): WixMeasuredFactory
Attaches reporter to current metrics, see [wix-measured-statsd-reporter](../wix-measured-statsd-reporter) for example implementation.

### WixMeasuredFactory.collection(): WixMeasured
Creates a `WixMeasured` instance.

### WixMeasuredFactory.collection(key, value): WixMeasured
Creates a `WixMeasured` instance with postfix `${key}=${value}`.

### WixMeasured.collection(key, value): WixMeasured
Creates a new `WixMeasured` instance containing all the existing collections with a new postfix `${key}=${value}`.

### WixMeasured.meter([key], name)(value)
Returns a function that will report a meter under `meter=${name}` if key is not provided or `${key}=${name}`.
_If a meter with the same id already exists, the existing function will be returned._

> Reports to `meter()` can't be read directly in Prometheus in Grafana. Instead they are trasformed and made available using the `m1_rate` metric. To understand how the calls you make to `meter()` will be mapped to `m1_rate` values, see [this test](https://github.com/wix-platform/wix-node-platform/blob/437b81f8c4623bb106df1fe9b48f412f931d16d4/private/monitoring/wix-measured/test/meter-m1rate.spec.js#L14-L29).

### WixMeasured.gauge(name)(fnOrValue)
Returns a function that will report a gauge under `gauge=${name}`.

Last created gauge is the only one that will actually report metrics. It practically disables reporting from any other gauges with the same name created before.

gauge value `fnOrValue` can be either function that returns a value, or you can set and update value directly which will be read upon publishing.

### WixMeasured.hist([key], name)(value)
Returns a function that will report a histogram under `hist=${name}` if key is not provided or `${key}=${name}`.
_If a meter with the same id already exists, the existing function will be returned._
