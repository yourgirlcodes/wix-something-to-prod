## *This is an internal module that should not be used directly from user code.*

# wnp-protobufjs

Loads and patches protobufjs

## Changes from original version

### util.isNode is set to true
https://github.com/protobufjs/protobuf.js/blob/master/src/util/minimal.js#L55
This is due to the precedence of window here https://github.com/protobufjs/protobuf.js/blob/master/src/util/minimal.js#L29
causes troubles with full-stack projects that use jsdom-global for their React stuff

### Google well-known types fields are camel-cased
see https://github.com/protobufjs/protobuf.js/issues/1397

### Multi options
The original version of `ReflectionObject#setOption` does not handle the case when an option is repeated multiple time on 
a single element and keeps only the last value in the `options` array.
The patched functionality creates an array called `rawOptions` which keeps all instances of an option
  
### Namespace lookup
The original version of `Namespace#lookup` does not work according to the protobuf specification which means an invalid proto file
will be loaded and parsed without errors.

#### The following cases are now identified as errors:
#### Case #1
The following file will be parsed correctly with ProtobufJS altough the request parameter `Empty` is not using a fully qualified form
```proto
syntax = "proto3";

package root;

import "google/protobuf/empty.proto";

service MyService {
  rpc Call (Empty) returns (google.protobuf.Empty);
}
```
The patched version will throw the following error: `no such type: Empty Did you mean google.protobuf.Empty`

#### Case #2 (Only in [strict](#rootstrictmode) mode)
The following files will be parsed correctly ProtobufJS altough the `details` field should be using the 
globally scoped qualifier `.level1.Details` because according to the protobuf specification, `level1.Details` should be resolved 
in this case as `root.level1.Details`  
```proto
//File: message.proto
syntax = "proto3";

package root.level1;

import "details.proto";

message Message {
  level1.Details details = 1;
}
```
```proto
//File: details.proto
syntax = "proto3";

package level1;

message Details {}
```
The patched version will throw the following error: `no such Type or enum: level1.Details Did you mean .level1.Details`

#### Case #3 (Only in alternateCommentMode)
The following file will throw parse error only in alternateCommentMode because the "bar1" comment comes right after comment "foo2"
```proto
syntax = "proto3";

message Request {

  // foo1
  int32 foo = 1; // foo2
  /**
  * bar1
  **/
  string bar = 2; // bar2
}
```
The patched version will run as expected


### Root#strictMode
If the Root object of a loaded protobuf has a `strictMode` property set to `true`, 
then during resolution ProtobufJS will work in a way that is more compliant with `protoc`  
Currently this only affects [Namespace lookup](#Namespace lookup)

### parsedOptions definition
see https://github.com/protobufjs/protobuf.js/pull/1507

### parsedOptions comments
In the root object the parsed options comments will appear under __comment field
```json
{
  "root": {
    "nested": {
      "MyService": {
        "parsedOptions": [
          {
            "(wix.api.service)": "service",
            "__comment": "api service comment"
          }, 
          {
            "(wix.api.service_entity)": {
              "a": "entity A",
              "b": "entity B"
            },
            "__comment": {
              "a": "comment A",
              "b": "comment B"
            }
          } 
        ]
      }
    }
  }
}
```

### ignore redundant semicolons
The following file will now be parsed correctly in the patched version:
```proto
service Service {
  rpc CallWithSingle(google.protobuf.Empty) returns(google.protobuf.Empty) {
    option (google.api.http) = {
      get: "/v1/get"; // <-- this will throw a parse error in the original version
      additional_bindings: {
        post: "/v1/post"; // <-- this will throw a parse error in the original version
      }; // <-- this will throw a parse error in the original version
    };
  };
};

```
The following file will now be parsed correctly in the patched version:  
(Fix taken from [here](https://github.com/protobufjs/protobuf.js/pull/1323))
```proto
message Bar {
  option deprecated = true;;;;;
  ;;;;
  int32 one = 1;;;;;
  ;repeated bool two = 2 [deprecated = true];;
  map<string, string> three = 3 [
    deprecated = false
  ];;;;
};;;;
```


### allow customizing the camelCase implementation
parse() now accepts an optional `camelCase` function which is used to convert field names to camelCase

## Patching procedure

1. run `npm run patch:prepare`<br>_this step installs a fresh copy of `protobufjs` and applies previous changes from 
`patches/protobufjs+X.X.X.patch` file using the [patch-package](https://www.npmjs.com/package/patch-package)._
2. make your changes under `node_modules/protobufjs`
3. run `npm run patch:finish`<br>_this step creates a new patch via the `patch-package` and also copies `node_modules/protobufjs` 
to `protobufjs` (bundled copy)._

