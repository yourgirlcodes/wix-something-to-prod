# wix-measured-metering

Metrics library with simplified API and adaptations towards wix infra.

## install

```bash
npm install --save @wix/wix-measured-metering
```

## usage

```js
const WixMeasuredFactory = require('@wix/wix-measured'),
  WixMetering = require('@wix/wix-measured-metering');

//should also have a reporter
const collection = new WixMeasuredFactory('localhost', 'anApp')
    .collection('collectionKey', 'collectionValue');

const metering = new WixMetering(collection);

//// promisified API                                           

// will publish histogram on 'collectionKey=collectionValue.fn=name'
metering.promise('fn', 'name')(() => Promise.resolve('ok'));             

// will publish meter (rate, count) on 'collectionKey=collectionValue.fn=name.error=Error.code=-100'.
metering.promise('fn', 'name')(() => Promise.reject(new Error('woop'))); 
                  
//// callback API

// will publish histogram on 'collectionKey=collectionValue.fn=name'
metering.callback('fn', 'name')(done => { /* do your stuff; */ done() });

// will publish meter (rate, count) on 'collectionKey=collectionValue.fn=name.error=Error.code=-100'.
metering.callback('fn', 'name')(done => { /* do your stuff; */ done(error) });
```

## Api

### WixMetering(WixMeasuredClient): WixMetering
constructor for WixMetering.

Arguments:
  - client - an instance of `WixMeasuredClient`.
 
### WixMetering#promise\<T\>(key: string, value: string): (() => Promise\<T\>) => (() => Promise\<T\>)
Creates a factory function that - given _fn_ returning a promise - will generate new function that:
 - will execute _fn_ 
 - will reports metrics for this execution
 - will propagate back the promise returned by _fn_ 

### WixMetering#raw(key: string, value: string): Object
Returns an object with two callbacks for metrics collection.
- `reportSuccess({duration = undefined, count = 1})` - report success, measure duration if provided.
   **Note** - if count is zero then the meter will not be updated 
- `reportError(err)` - report failure

### WixMetering#callback(key: string, value: string): (done: (void | Error) => void)
Executes provided callback and adds metrics reporting.
You **must** call `done` callback:
- for successful execution - `done()`
- for error - `done(error)`

## Testkit
[wix-metering-testkit](../../../testing/wix-metering-testkit)
