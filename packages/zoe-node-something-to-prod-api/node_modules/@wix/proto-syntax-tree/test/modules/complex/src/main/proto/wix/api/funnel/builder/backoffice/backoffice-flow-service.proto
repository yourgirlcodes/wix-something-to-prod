syntax = "proto3";

package wix.api.funnel.builder.backoffice;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/wrappers.proto";
import "google/protobuf/timestamp.proto";

import "wix/api/annotations.proto";
import "wix/api/permissions.proto";
import "wix/api/validations.proto";
import "wix/api/context.proto";
import "wix/common/paging.proto";

import "wix/api/funnel/builder/backoffice/monitoring.proto";
import "wix/api/funnel/builder/backoffice/flow.proto";
import "wix/api/funnel/builder/backoffice/flow-snapshot.proto";

service BackofficeFlowService {
    rpc CreateFlow (CreateFlowRequest) returns (CreateFlowResponse) {
        option (google.api.http).post = "/backoffice/flows";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
        option (wix.api.required) = "CreateFlowRequest.flow";
    }

    rpc GetFlow (GetFlowRequest) returns (GetFlowResponse) {
        option (google.api.http).get = "/backoffice/flows/{id}";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }

    rpc ListFlows (ListFlowsRequest) returns (ListFlowsResponse) {
        option (google.api.http).get = "/backoffice/flows";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }

    rpc SetFlow (SetFlowRequest) returns (SetFlowResponse) {
        option (google.api.http).put = "/backoffice/flows/{id}";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.required) = "SetFlowRequest.flow";
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }

    // generates monitoring dashboard for published flow snapshot
    rpc GenerateMonitoringDashboard (GenerateMonitoringDashboardRequest) returns (GenerateMonitoringDashboardResponse) {
        option (google.api.http).post = "/backoffice/flows/{flow_id}/generate-monitoring-dashboard";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }

    rpc CreateFlowSnapshot (CreateFlowSnapshotRequest) returns (CreateFlowSnapshotResponse) {
        option (google.api.http).post = "/backoffice/flows/{flow_id}/snapshots";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }

    rpc ListFlowSnapshots (ListFlowSnapshotsRequest) returns (ListFlowSnapshotsResponse) {
        option (google.api.http).get = "/backoffice/flows/{flow_id}/snapshots";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }

    rpc PublishFlowSnapshot (PublishFlowSnapshotRequest) returns (PublishFlowSnapshotResponse) {
        option (google.api.http).post = "/backoffice/flows/{flow_id}/snapshots/{revision}/publish";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }

    rpc DeleteFlow (DeleteFlowRequest) returns (DeleteFlowResponse) {
        option (google.api.http).delete = "/backoffice/flows/{id}";
        option (wix.api.maturity) = ALPHA;
        option (wix.api.exposure) = INTERNAL;
        option (wix.api.permission).name = "FUNNEL_INTRO.MANAGE_CONTENT";
    }
}

message CreateFlowRequest {
    Flow flow = 1;
}

message CreateFlowResponse {
    Flow flow = 1;
}

message GetFlowRequest {
    string id = 1 [(wix.api.format) = GUID];
}

message GetFlowResponse {
    Flow flow = 1;
}

message ListFlowsRequest {
    wix.common.Paging paging = 1;
}

message ListFlowsResponse {
    repeated Flow flows = 1;
}

message SetFlowRequest {
    string id = 1 [(wix.api.format) = GUID];

    // Expected version performing the operation. Will fail on no match.
    int32 version = 2 [(wix.api.min) = 1];

    Flow flow = 3;
}

message SetFlowResponse {
    Flow flow = 1;
}

message GenerateMonitoringDashboardRequest {
    string flow_id = 1 [(wix.api.format) = GUID];
}

message GenerateMonitoringDashboardResponse {
    MonitoringDashboardDetails monitoring_dashboard_details = 1;
}

message CreateFlowSnapshotRequest {
    string flow_id = 1 [(wix.api.format) = GUID];
}

message CreateFlowSnapshotResponse {
    string flow_snapshot_id = 1 [(wix.api.format) = GUID];
}

message ListFlowSnapshotsRequest {
    string flow_id = 1 [(wix.api.format) = GUID];
}

message ListFlowSnapshotsResponse {
    repeated FlowSnapshotMetadata flowSnapshots = 1;
}

message PublishFlowSnapshotRequest {
    string flow_id = 1 [(wix.api.format) = GUID];

    int32 revision = 2 [(wix.api.min) = 1];
}

message PublishFlowSnapshotResponse {

}

message DeleteFlowRequest {
    string id = 1 [(wix.api.format) = GUID];
}

message DeleteFlowResponse {
    Flow flow = 1;
}
