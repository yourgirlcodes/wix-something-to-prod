const {join} = require('path'),
  assert = require('assert'),
  {readdirSync, statSync} = require('fs'),
  {execSync} = require('child_process');

module.exports = () => {
  const logPrefix = `copy-config-templates(${require(join(process.cwd(), 'package.json')).name}): NODE_ENV='${process.env.NODE_ENV}'`;
  const srcDir = process.cwd() + '/templates';

  if (isProduction()) {
    assert(process.env.APP_TEMPL_DIR, 'NODE_ENV=\'production\', but APP_TEMPL_DIR not set, cannot copy config templates.');
    assert(directoryExists(srcDir), `${logPrefix}, but '${srcDir}' does not exist.`);
    assert(listFiles(srcDir).length !== 0, `${logPrefix}, but '${srcDir}' is empty`);

    const targetDir = join(process.env.APP_TEMPL_DIR, '');

    console.info(`${logPrefix}, copying configs from '${srcDir}' to '${targetDir}'`);
    // We do retries for monorepo cases when theoretically few instances of the same module
    // could exist. We assume there is no conflicts in the .erb files
    withRetries(() => execSync(`cp -R ${srcDir}/* ${targetDir}/`));
  } else {
    console.info(`${logPrefix}, skipping...`);
  }
};

function withRetries(fn, attempt = 0) {
  try {
    return fn();
  } catch (err) {
    if (attempt < 3) {
      return withRetries(fn, attempt + 1);
    } else {
      throw err;
    }
  }
}

function isProduction() {
  return process.env.NODE_ENV === 'production';
}

function directoryExists(path) {
  try {
    return statSync(path).isDirectory();
  } catch (e) {
    return false;
  }
}

function listFiles(path) {
  try {
    return readdirSync(path);
  } catch (e) {
    return [];
  }
}
